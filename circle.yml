machine:
  timezone:
    Europe/Vienna
  environment:
    ANDROID_HOME: /usr/local/android-sdk-linux
dependencies:
  cache_directories:
    - ~/.android
    - "~/.gradle"
  override:
    - android list sdk --all | grep -i tools
  pre:
    #- export PATH="$ANDROID_HOME/platform-tools:$ANDROID_HOME/tools:$PATH" ;
    - echo y | android update sdk --no-ui --all --filter build-tools-23.0.0
    - rm -v .google_apis/._.DS_Store ._.DS_Store surespot/libs/* surespot/src/main/res/raw/ffmpegpie surespot/src/main/res/raw/ffmpeg surespotcommon/libs/*.jar ;
      git clone https://github.com/zoff99/gcm-client-old.git ;
      mkdir -p surespot/src/main/java/com/ ;
      pwd ;
      cp -av gcm-client-old/com surespot/src/main/java/ ;
      ls -al ~/surespot-android/surespot/src/main/java/com/ ;
      ls -al ~/surespot-android/surespot/src/main/java/com/google/ ;
      echo "xxxxxxxxxxxxxxxx" ;
      ls -al ~/surespot-android/surespot/src/main/java/com/twofours/surespot/backup ;
      echo "xxxxxxxxxxxxxxxx" ;
      git apply -v --ignore-whitespace patches/Ex-63.patch ;
      git apply -v --ignore-whitespace patches/Im-63.patch ;
      mv tmp/E3.java surespot/src/main/java/com/twofours/surespot/backup/ExportIdentityActivity.java ;
      mv tmp/I3.java surespot/src/main/java/com/twofours/surespot/backup/ImportIdentityActivity.java ;
      echo "EEEEEEEEEEEE" ;
      cat surespot/src/main/java/com/twofours/surespot/backup/ExportIdentityActivity.java ;
      echo "EEEEEEEEEEEE" ;
      echo "--IIIIIIII--" ;
      cat surespot/src/main/java/com/twofours/surespot/backup/ImportIdentityActivity.java ;
      echo "--IIIIIIII--" ;
      echo "yyyyyyyyyyyyyyyy" ;
      ls -al ~/surespot-android/surespot/src/main/java/com/twofours/surespot/backup ;
      echo "yyyyyyyyyyyyyyyy" ;
      cd surespot ;
      pwd; ls -al ;
      touch src/main/res/raw/ffmpegpie src/main/res/raw/ffmpeg ;
      sed -i -e 's#com.google.android.gms:play-services-drive:7.8.0#com.android.support:support-v4:19.0.1#' build.gradle ;
      mkdir -p ../surespotcommon/src/main/res/raw ;
      sed -i -e 's#Build.VERSION_CODES.M#23#' src/main/java/com/twofours/surespot/identity/IdentityController.java ;
      printf 'ssl_strict=true\nbaseUrl=https://server.surespot.me:443\n' > ../surespotcommon/src/main/res/raw/configuration.properties ;
      sed -i -e 's#import java.util.Properties;#import java.util.Properties;\nimport com.twofours.surespot.common.R;\n#g' ../surespotcommon/src/main/java/com/twofours/surespot/common/SurespotConfiguration.java ;
      sed -i -e 's#@integer/google_play_services_version#4030500#' src/main/AndroidManifest.xml ;
      awk 'NR<=21||NR>=62' proguard-project.txt > proguard-project.txt_ ;
      mv proguard-project.txt_ proguard-project.txt ;
      sed -i -e 's#import org.acra.ACRA;##' ../androidasynchttp/src/main/java/com/loopj/android/http/AsyncHttpRequest.java src/main/java/com/twofours/surespot/SurespotApplication.java ;
      sed -i -e 's#import org.acra.ReportingInteractionMode;##' -e 's#import org.acra.annotation.ReportsCrashes;##' -e 's#ACRA.init(this);##' -e 's#@ReportsCrashes#// @ReportsCrashes#' -e 's#formUri = "ht#// formUri = "ht#' src/main/java/com/twofours/surespot/SurespotApplication.java ;
      sed -i -e 's#compile files(.libs/gcm.jar.)##' -e 's#compile files(.*libs.*)##' -e 's#android {#android {\nlintOptions {\nabortOnError false\n}\n#' build.gradle ;
      sed -i -e 's#javaMaxHeapSize .*##' build.gradle ;
      rm src/main/java/com/twofours/surespot/backup/DriveHelper.java ;
      pushd ../ ;
      find .google_apis -name '*.jar' -exec rm {} \; ;
      popd ;
      sed -i -e '/support-v4/acompile "com.madgag:scprov-jdk15on:1.47.0.3"\ncompile "com.madgag:sc-light-jdk15on:1.47.0.3"' -e '/compile files/d' build.gradle ;
      sed -i -e '/surespotcommon/acompile "com.madgag:scprov-jdk15on:1.47.0.3"\ncompile "com.madgag:sc-light-jdk15on:1.47.0.3"' -e '/compile files/d' ../androidkeystore/build.gradle ;
      pwd ; ls -al ;
      cd .. ;
      ln -s surespot src ;
      echo ./gradlew test --info --stacktrace --parallel ;
      ./gradlew tasks;
      pwd ; ls -al
test:
  override:
    - echo "aa"

machine:
  timezone:
    Europe/Vienna
  environment:
    EMU_: "surespot23"
    XEMU_: "surespot10"
    sdpath: "/storage/sdcard"
    Xsdpath: "/mnt/sdcard"
    ANDROID_HOME: /usr/local/android-sdk-linux
    ANDROID_SDK: /usr/local/android-sdk-linux/
    _SDK_: /usr/local/android-sdk-linux/
dependencies:
  cache_directories:
    - ~/.android
    - ~/.gradle
  override:
    - android list sdk --all | grep -i tools
    - android list sdk --all --extended
  pre:
    - sudo apt-get update # > /dev/null 2> /dev/null
    - sudo apt-get install xvfb > /dev/null 2> /dev/null
    - sudo apt-get install xdotool > /dev/null 2> /dev/null
    - sudo apt-get install telnet
    - sudo apt-get install x11-utils
    - sudo apt-get install xvkbd
    - echo y | android update sdk --no-ui --all --filter build-tools-23.0.0
    - echo y | android update sdk --no-ui --all --filter android-23
    - rm -v .google_apis/._.DS_Store ._.DS_Store ;
      git clone https://github.com/zoff99/gcm-client-old.git ;
      mkdir -p surespot/src/main/java/com/ ;
      cp -av gcm-client-old/com surespot/src/main/java/ ;
      cd surespot ;
      cat src/main/java/com/twofours/surespot/SurespotApplication.java | grep 'DEBUG_CI =' ;
      sed -i -e 's#DEBUG_CI = 0;#DEBUG_CI = 1;#' src/main/java/com/twofours/surespot/SurespotApplication.java ;
      cat src/main/java/com/twofours/surespot/SurespotApplication.java | grep 'DEBUG_CI =' ;
      mkdir -p ../surespotcommon/src/main/res/raw ;
      printf 'ssl_strict=true\nbaseUrl=https://server.surespot.me:443\n' > ../surespotcommon/src/main/res/raw/configuration.properties ;
      pushd ../ ;
      find .google_apis -name '*.jar' -exec rm {} \; ;
      popd ;
      cd .. ;
      ln -s surespot src ;
      echo ./gradlew tasks ;
      ./gradlew assembleRelease --info --stacktrace ;
      echo;echo;echo;
      pwd ; ls -al;
      cp -av ./surespot/build/outputs/apk/surespot-release-unsigned.apk ~/ ;
      cd ~/ ;
      echo xxxxxxrm -f ~/.android/debug.keystore ;
      ls -al ~/.android/debug.keystore ;
      if [ ! -f ~/.android/debug.keystore ]; then echo "*** generating new signer key ***" ;
      echo "*** generating new signer key ***";
      echo "*** generating new signer key ***";
      keytool -genkey -v -keystore ~/.android/debug.keystore -storepass android -keyalg RSA -keysize 2048 -validity 10000 -alias androiddebugkey -keypass android -dname "CN=Android Debug,O=Android,C=US" ;
      fi ;
      jarsigner -verbose -keystore ~/.android/debug.keystore -storepass android -keypass android -sigalg SHA1withRSA -digestalg SHA1 -sigfile CERT -signedjar surespot-release-signed.apk surespot-release-unsigned.apk androiddebugkey > /dev/null 2> /dev/null ;
      $_SDK_/build-tools/23.0.1/zipalign -v 4 surespot-release-signed.apk surespot-release-signed-aligned.apk > /dev/null 2> /dev/null ;
      pwd ;
      ls -al ;
      cp -av surespot-release-signed-aligned.apk $CIRCLE_ARTIFACTS/surespot_circleci_$CIRCLE_SHA1.apk || exit 1
test:
  pre:
    - mksdcard -l e 180M sdcard.img
    - echo 'mtools_skip_check=1' > ~/.mtoolsrc
    - android list targets
#
    - if [ "$EMU_" == "surespot23" ]; then echo "no" | android create avd -n surespot23 -f -t android-21 --abi default/armeabi-v7a --skin "WXGA800-7in" ; fi
    - if [ "$EMU_" == "surespot23" ]; then cat ~/.android/avd/surespot23.avd/config.ini ; fi
    - if [ "$EMU_" == "surespot23" ]; then echo "more RAM" ; sed -i -e 's#.*hw.ramSize=.*#hw.ramSize=1014MB#' ~/.android/avd/surespot23.avd/config.ini ; cat ~/.android/avd/surespot23.avd/config.ini ; fi
    - if [ "$EMU_" == "surespot23" ]; then echo "more HEAP" ; sed -i -e 's#.*vm.heapSize=.*#vm.heapSize=64MB#' ~/.android/avd/surespot23.avd/config.ini ; cat ~/.android/avd/surespot23.avd/config.ini ; fi
    - if [ "$EMU_" == "surespot23" ]; then cat ~/.android/avd/surespot23.avd/config.ini ; fi
#
    - if [ "$EMU_" == "surespot10" ]; then echo "no" | android create avd -n surespot10 -f -t android-10 --abi default/armeabi --skin "WVGA854" ; fi
    - if [ "$EMU_" == "surespot10" ]; then cat ~/.android/avd/surespot10.avd/config.ini ; fi
    - if [ "$EMU_" == "surespot10" ]; then echo "more RAM" ; sed -i -e 's#.*hw.ramSize=.*#hw.ramSize=1024MB#' ~/.android/avd/surespot10.avd/config.ini ; cat ~/.android/avd/surespot10.avd/config.ini ; fi
    - if [ "$EMU_" == "surespot10" ]; then cat ~/.android/avd/surespot10.avd/config.ini ; fi
#
    - echo "$EMU_"
    - echo "$sdpath"
  override:
    - emulator -avd "$EMU_" -sdcard sdcard.img -no-audio:
        background: true
        parallel: true
    - circle-android wait-for-boot
    - xwininfo -root -tree
    - import -window root $CIRCLE_ARTIFACTS/capture000.png
    - xdotool search --name "DDMS"
    - for i in `xdotool search --name "DDMS" 2>/dev/null`; do xdotool windowfocus "$i" ; xdotool key "Return" xdotool key "alt+F4" ; sleep 1 ; done ; exit 0
    - xdotool search --name "DDMS"
    #- xdotool search --name "DDMS" key "alt+F4"
    - import -window root $CIRCLE_ARTIFACTS/capture001.png
    - sleep 10
    #- printf 'event send EV_KEY:KEY_MENU:1 EV_KEY:KEY_MENU:0\nquit\n' | telnet localhost 5554 ; exit 0
    - printf 'event send EV_KEY:KEY_MENU:1\nquit\n' | telnet localhost 5554 ; exit 0
    - printf 'event send EV_KEY:KEY_MENU:0\nquit\n' | telnet localhost 5554 ; exit 0
    - sleep 20
    - import -window root $CIRCLE_ARTIFACTS/capture002.png

    - fb-adb shell "cat /proc/meminfo" ; exit 0
    - fb-adb shell "free" ; exit 0
    - fb-adb shell "sysctl vm.swappiness" ; exit 0

    - adb install $CIRCLE_ARTIFACTS/surespot_circleci_$CIRCLE_SHA1.apk

    - adb logcat -v time > $CIRCLE_ARTIFACTS/adb_out.txt 2>&1 :
        background: true

    - fb-adb shell am start -n com.twofours.surespot/com.twofours.surespot.activities.MainActivity

    - sleep 210
    - import -window root $CIRCLE_ARTIFACTS/capture003.png

    - fb-adb shell am force-stop com.twofours.surespot

    - cat $CIRCLE_ARTIFACTS/adb_out.txt | grep "xxyy--DEVICE-SCREENSHOT--xxyy" |sed -e 's#^.*xxyy--DEVICE-SCREENSHOT--xxyy:##'
    - scr001=`cat $CIRCLE_ARTIFACTS/adb_out.txt | grep "xxyy--DEVICE-SCREENSHOT--xxyy" |sed -e 's#^.*xxyy--DEVICE-SCREENSHOT--xxyy:##'` ; fb-adb pull "$scr001" $CIRCLE_ARTIFACTS/scr001.png

    #- pkill -9 -u ubuntu -f emulator64-arm



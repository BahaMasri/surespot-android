machine:
  timezone:
    Europe/Vienna
  environment:
    ANDROID_HOME: /usr/local/android-sdk-linux
    ANDROID_SDK: /usr/local/android-sdk-linux/
    _SDK_: /usr/local/android-sdk-linux/
dependencies:
  cache_directories:
    - ~/.android
    - ~/.gradle
  override:
    #- android list sdk --all | grep -i tools
    - android list sdk --all --extended
  pre:
    #- export PATH="$ANDROID_HOME/platform-tools:$ANDROID_HOME/tools:$PATH" ;
    - echo y | android update sdk --no-ui --all --filter build-tools-23.0.0
    - echo y | android update sdk --no-ui --all --filter android-23
    - rm -v .google_apis/._.DS_Store ._.DS_Store ;
      git clone https://github.com/zoff99/gcm-client-old.git ;
      mkdir -p surespot/src/main/java/com/ ;
      cp -av gcm-client-old/com surespot/src/main/java/ ;
      cd surespot ;
      mkdir -p ../surespotcommon/src/main/res/raw ;
      printf 'ssl_strict=true\nbaseUrl=https://server.surespot.me:443\n' > ../surespotcommon/src/main/res/raw/configuration.properties ;
      pushd ../ ;
      find .google_apis -name '*.jar' -exec rm {} \; ;
      popd ;
      cd .. ;
      ln -s surespot src ;
      echo ./gradlew tasks ;
      ./gradlew assembleRelease --info --stacktrace ;
      echo;echo;echo;
      pwd ; ls -al;
      cp -av ./surespot/build/outputs/apk/surespot-release-unsigned.apk ~/ ;
      cd ~/ ;
      echo xxxxxxrm -f ~/.android/debug.keystore ;
      ls -al ~/.android/debug.keystore ;
      if [ ! -f ~/.android/debug.keystore ]; then echo "*** generating new signer key ***" ;
      echo "*** generating new signer key ***";
      echo "*** generating new signer key ***";
      keytool -genkey -v -keystore ~/.android/debug.keystore -storepass android -keyalg RSA -keysize 2048 -validity 10000 -alias androiddebugkey -keypass android -dname "CN=Android Debug,O=Android,C=US" ;
      fi ;
      jarsigner -verbose -keystore ~/.android/debug.keystore -storepass android -keypass android -sigalg SHA1withRSA -digestalg SHA1 -sigfile CERT -signedjar surespot-release-signed.apk surespot-release-unsigned.apk androiddebugkey > /dev/null 2> /dev/null ;
      $_SDK_/build-tools/23.0.1/zipalign -v 4 surespot-release-signed.apk surespot-release-signed-aligned.apk > /dev/null 2> /dev/null ;
      pwd ;
      ls -al ;
      cp -av surespot-release-signed-aligned.apk $CIRCLE_ARTIFACTS/surespot_circleci_$CIRCLE_SHA1.apk || exit 1
test:
  override:
    - echo "aa"
